

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CoREMOF.calculation.mof_collection &mdash; CoREMOF_tools 0.0.6 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=1fd71caa"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            CoREMOF_tools
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">CoREMOF_tools API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">CoREMOF_tools</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">CoREMOF.calculation.mof_collection</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for CoREMOF.calculation.mof_collection</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pylab</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">cpu_count</span><span class="p">,</span> <span class="n">Array</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">CoREMOF.calculation.mof</span><span class="w"> </span><span class="kn">import</span> <span class="n">Helper</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">CoREMOF.calculation.mof</span><span class="w"> </span><span class="kn">import</span> <span class="n">MofStructure</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">CoREMOF.calculation.atomic_parameters</span><span class="w"> </span><span class="kn">import</span> <span class="n">Atom</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sys</span><span class="w"> </span><span class="kn">import</span> <span class="n">exit</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_rows</span> <span class="o">=</span> <span class="mi">1000</span>


<div class="viewcode-block" id="MofCollection">
<a class="viewcode-back" href="../../../CoREMOF.calculation.html#CoREMOF.calculation.mof_collection.MofCollection">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MofCollection</span><span class="p">:</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;A collection to hold and analyse MOF structures from CIF files. Create a MofCollection from a list of path names.</span>

<span class="sd">    Args:</span>
<span class="sd">        path_list: List of paths to MOF CIF files to be added to the collection.</span>
<span class="sd">        analysis_folder: Path to the folder where the results will be stored.&quot;&quot;&quot;</span>

    <span class="n">separator</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;-&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_list</span><span class="p">,</span> <span class="n">analysis_folder</span><span class="o">=</span><span class="s1">&#39;analysis_folder&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_folder</span> <span class="o">=</span> <span class="n">analysis_folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_list</span> <span class="o">=</span> <span class="n">path_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metal_site_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mof_oms_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_balance_index</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_limit</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filter_functions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;density&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_filter_range</span><span class="p">,</span>
            <span class="s2">&quot;oms_density&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_filter_range</span><span class="p">,</span>
            <span class="s2">&quot;uc_volume&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_filter_range</span><span class="p">,</span>
            <span class="s2">&quot;metal_species&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_filter_in_value</span><span class="p">,</span>
            <span class="s2">&quot;non_metal_species&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_filter_in_value</span><span class="p">,</span>
            <span class="s2">&quot;cif_okay&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_filter_value</span><span class="p">,</span>
            <span class="s2">&quot;has_oms&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_filter_value</span><span class="p">,</span>
            <span class="s2">&quot;mof_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_value_in_filter</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_load_mofs</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">print_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span>
        <span class="n">print_str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">This collection holds information for &quot;</span>
        <span class="n">print_str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> MOFs.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">print_str</span> <span class="o">+=</span> <span class="s2">&quot;Analysis folder is not set.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_folder</span><span class="p">)</span>
            <span class="n">print_str</span> <span class="o">+=</span> <span class="s2">&quot;Analysis folder is: </span><span class="si">{}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">print_str</span> <span class="o">+=</span> <span class="s2">&quot;List of cif files in collection:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">mc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">:</span>
            <span class="n">print_str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mc</span><span class="p">[</span><span class="s1">&#39;mof_file&#39;</span><span class="p">])</span>
        <span class="n">print_str</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span>

        <span class="k">return</span> <span class="n">print_str</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get value of the analysis folder.&quot;&quot;&quot;</span>
        <span class="n">Helper</span><span class="o">.</span><span class="n">make_folder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_analysis_folder</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_folder</span>

    <span class="nd">@analysis_folder</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">analysis_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_folder</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set value of the analysis folder.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_folder</span> <span class="o">=</span> <span class="n">analysis_folder</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">oms_results_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get value of the OMS results folder.&quot;&quot;&quot;</span>
        <span class="n">orf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_folder</span> <span class="o">+</span> <span class="s1">&#39;/oms_results&#39;</span>
        <span class="n">Helper</span><span class="o">.</span><span class="n">make_folder</span><span class="p">(</span><span class="n">orf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">orf</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">summary_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get value of the summary folder.&quot;&quot;&quot;</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_folder</span> <span class="o">+</span> <span class="s1">&#39;/summary&#39;</span>
        <span class="n">Helper</span><span class="o">.</span><span class="n">make_folder</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sf</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_properties_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get value of the properties pickle file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_folder</span> <span class="o">+</span> <span class="s1">&#39;/properties.pickle&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get value for the MOF properties. If the property variable is not None and the pickle file exists, then load the file and return it.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_properties_filename</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_properties_filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">properties_file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">properties_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mof_oms_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a pandas DataFrame that lists for each MOF whether it has an OMS or not and if it has an OMS what metal types it is.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mof_oms_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mof_oms_df</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_properties</span><span class="p">([</span><span class="s1">&#39;has_oms&#39;</span><span class="p">])[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;OMS analysis not finished for all MOFs in collection.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">mof_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">mi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">:</span>
            <span class="n">mp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;checksum&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="s1">&#39;metal_sites&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mp</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">metal_sites</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s1">&#39;metal_sites&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metal_sites</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Metal Found in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mp</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
            <span class="n">oms_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">ms</span><span class="p">[</span><span class="s2">&quot;metal&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">metal_sites</span>
                         <span class="k">if</span> <span class="n">ms</span><span class="p">[</span><span class="s2">&quot;is_open&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ms</span><span class="p">[</span><span class="s2">&quot;unique&quot;</span><span class="p">]]</span>
            <span class="n">oms_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">oms_types</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">oms_types</span><span class="p">:</span>
                <span class="n">oms_types</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oms_types</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">oms_types</span> <span class="o">=</span> <span class="s2">&quot;N/A&quot;</span>
            <span class="k">if</span> <span class="n">mp</span><span class="p">[</span><span class="s1">&#39;has_oms&#39;</span><span class="p">]:</span>
                <span class="n">has_oms</span> <span class="o">=</span> <span class="s1">&#39;Yes&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">has_oms</span> <span class="o">=</span> <span class="s1">&#39;No&#39;</span>
            <span class="n">all_metal_species</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">mp</span><span class="p">[</span><span class="s1">&#39;metal_species&#39;</span><span class="p">]))</span>
            <span class="n">mof_info</span><span class="p">[</span><span class="n">mp</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Metal Types&#39;</span><span class="p">:</span> <span class="n">all_metal_species</span><span class="p">,</span>
                                    <span class="s1">&#39;Has OMS&#39;</span><span class="p">:</span> <span class="n">has_oms</span><span class="p">,</span>
                                    <span class="s1">&#39;OMS Types&#39;</span><span class="p">:</span> <span class="n">oms_types</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metal_site_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">mof_info</span><span class="p">,</span>
                                                     <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metal_site_df</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">metal_site_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a pandas DataFrame that lists the OMS results for each metal type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metal_site_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metal_site_df</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_properties</span><span class="p">([</span><span class="s1">&#39;has_oms&#39;</span><span class="p">])[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;OMS analysis not finished for all MOFs in collection.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">site_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">mi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">:</span>
            <span class="n">mp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;checksum&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="s1">&#39;metal_sites&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mp</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">metal_sites</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s1">&#39;metal_sites&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metal_sites</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Metal Found in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mp</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ms</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metal_sites</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">site_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ms</span>
                <span class="k">if</span> <span class="s1">&#39;all_dihedrals&#39;</span> <span class="ow">in</span> <span class="n">ms</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">site_info</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;all_dihedrals&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;min_dihedral&#39;</span> <span class="ow">in</span> <span class="n">ms</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">site_info</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;min_dihedral&#39;</span><span class="p">]</span>
                <span class="n">site_info</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;mof_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metal_site_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">site_info</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metal_site_df</span>

<div class="viewcode-block" id="MofCollection.from_folder">
<a class="viewcode-back" href="../../../CoREMOF.calculation.html#CoREMOF.calculation.mof_collection.MofCollection.from_folder">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_folder</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">collection_folder</span><span class="p">,</span> <span class="n">analysis_folder</span><span class="o">=</span><span class="s1">&#39;analysis_folder&#39;</span><span class="p">,</span> <span class="n">name_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a MofCollection from a the CIF files in a folder.</span>

<span class="sd">        Args:</span>
<span class="sd">            collection_folder: Path to the folder containing the CIF files to be added to the collection.</span>
<span class="sd">            analysis_folder: Path to the folder where the results will be stored.</span>
<span class="sd">            name_list: List of MOF names to include in the collection. If set, all the other CIF files in the folder will be excluded.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A MofCollection object holding the specified MOF structures.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">name_list</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using only MOFs in the name list.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">collection_folder</span>
            <span class="n">path_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">name_list</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">collection_folder</span> <span class="o">+</span> <span class="s2">&quot;/*.cif&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">path_list</span><span class="p">,</span> <span class="n">analysis_folder</span><span class="p">)</span></div>


<div class="viewcode-block" id="MofCollection.analyse_mofs">
<a class="viewcode-back" href="../../../CoREMOF.calculation.html#CoREMOF.calculation.mof_collection.MofCollection.analyse_mofs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyse_mofs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_batches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">analysis_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run OMS analysis for the MOFs in the collection.</span>

<span class="sd">        Args:</span>
<span class="sd">            overwrite: Controls if the results will be overwritten or not.</span>
<span class="sd">            num_batches: Sets the number of batches the structures will be split in and analyzed on a separate process.</span>
<span class="sd">            analysis_limit: Analyze only up to the number of MOFs set by analysis_limit, if set to None all MOFs will be analyzed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running OMS Analysis...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_limit</span> <span class="o">=</span> <span class="n">analysis_limit</span>

        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_make_batches</span><span class="p">(</span><span class="n">num_batches</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_batches</span><span class="p">)])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_batch</span><span class="p">,</span>
                        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">,</span><span class="n">status</span><span class="p">))</span>
            <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">lbs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span><span class="o">/</span><span class="mf">100.0</span> <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">]</span>
        <span class="n">wait_time</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">status_prev</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_batches</span><span class="p">)]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Create a list from the shared array to make sure it doesnt change</span>
            <span class="c1"># during the iteration</span>
            <span class="n">status_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">sp</span> <span class="o">==</span> <span class="n">s</span> <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">status_prev</span><span class="p">,</span> <span class="n">status_</span><span class="p">)]):</span>
                <span class="n">wait_time</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mf">0.1</span><span class="o">+</span><span class="n">wait_time</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait_time</span><span class="p">)</span>
            <span class="n">status_prev</span> <span class="o">=</span> <span class="n">status_</span>

            <span class="n">sout</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Batch </span><span class="si">{}</span><span class="s2"> Finished.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span>
                    <span class="s2">&quot;Batch </span><span class="si">{}</span><span class="s2"> </span><span class="si">{:.2f}</span><span class="s2"> % : Analysing </span><span class="si">{:}</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">lbs</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;mof_name&#39;</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">status_</span><span class="p">)]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;|**| &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sout</span><span class="p">)</span> <span class="o">+</span> <span class="mi">100</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">s</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">status_</span><span class="p">]):</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">mi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_property_from_oms_result</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_properties</span><span class="p">([</span><span class="s1">&#39;has_oms&#39;</span><span class="p">])</span>

        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Analysis Finished. Time required:</span><span class="si">{:.2f}</span><span class="s1"> sec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span></div>


<div class="viewcode-block" id="MofCollection.check_structures">
<a class="viewcode-back" href="../../../CoREMOF.calculation.html#CoREMOF.calculation.mof_collection.MofCollection.check_structures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_structures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over all the MOFs in the collection and validate that they can be read and a MofStructure can be created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_properties</span><span class="p">([</span><span class="s1">&#39;cif_okay&#39;</span><span class="p">])</span>
        <span class="n">not_read</span> <span class="o">=</span> <span class="p">[</span><span class="n">mi</span> <span class="k">for</span> <span class="n">mi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;checksum&#39;</span><span class="p">]][</span><span class="s1">&#39;cif_okay&#39;</span><span class="p">]]</span>
        <span class="n">read_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_read</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Checked </span><span class="si">{}</span><span class="s1"> structures.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">)))</span>
        <span class="n">msg1</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> was read.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">read_len</span><span class="p">),</span>
                <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> were read.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">read_len</span><span class="p">)}</span>
        <span class="n">msg2</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> was NOT read.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">not_read</span><span class="p">)),</span>
                <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> were NOT read.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">not_read</span><span class="p">))}</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg1</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">read_len</span><span class="p">)])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg2</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_read</span><span class="p">))])</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The following structures could not be read:&quot;</span><span class="p">}</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_read</span><span class="p">))])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">not_read</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;mof_name&#39;</span><span class="p">]))</span>

        <span class="n">mofs_no_metal</span> <span class="o">=</span> <span class="p">[</span><span class="n">mi</span> <span class="k">for</span> <span class="n">mi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span>
                         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;checksum&#39;</span><span class="p">]][</span><span class="s1">&#39;cif_okay&#39;</span><span class="p">]</span>
                         <span class="ow">and</span> <span class="ow">not</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;checksum&#39;</span><span class="p">]][</span><span class="s1">&#39;metal_species&#39;</span><span class="p">]]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;The following structures contain no metal:&quot;</span><span class="p">}</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mofs_no_metal</span><span class="p">))])</span>
        <span class="k">for</span> <span class="n">mi</span> <span class="ow">in</span> <span class="n">mofs_no_metal</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;checksum&#39;</span><span class="p">]]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.cif </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                                     <span class="n">p</span><span class="p">[</span><span class="s1">&#39;metal_species&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;non_metal_species&#39;</span><span class="p">]))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Finished checking structures.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MofCollection.check_analysis_status">
<a class="viewcode-back" href="../../../CoREMOF.calculation.html#CoREMOF.calculation.mof_collection.MofCollection.check_analysis_status">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_analysis_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over all the MOFs in the collection and check if the results from the OMS analysis exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span>
        <span class="n">not_done</span> <span class="o">=</span> <span class="p">[</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;mof_file&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">mi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_if_results_exist</span><span class="p">(</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;mof_name&#39;</span><span class="p">])]</span>
        <span class="n">done</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_done</span><span class="p">)</span>
        <span class="n">msg1</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Analysis for no structures has been completed.&#39;</span><span class="p">,</span>
                <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Analysis for </span><span class="si">{}</span><span class="s1"> out of </span><span class="si">{}</span><span class="s1"> structures have been completed.&#39;</span>
                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">done</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">))}</span>
        <span class="n">msg2</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The following structures are missing:&quot;</span><span class="p">}</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">msg1</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">done</span><span class="p">)])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg2</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_done</span><span class="p">))])</span>
        <span class="k">for</span> <span class="n">nd</span> <span class="ow">in</span> <span class="n">not_done</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">nd</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span></div>


<div class="viewcode-block" id="MofCollection.sample_collection">
<a class="viewcode-back" href="../../../CoREMOF.calculation.html#CoREMOF.calculation.mof_collection.MofCollection.sample_collection">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sample_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_size</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Randomly select a sample of MOFs in the collection and return a new collection with the MOFs in the sample.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_size: Number of MOFs to be selected. Default value is 50.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ll</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sample_size</span> <span class="o">&gt;</span> <span class="n">ll</span><span class="p">:</span>
            <span class="n">sample_size</span> <span class="o">=</span> <span class="n">ll</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can only sample up to the number of MOFs &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;in the collection (</span><span class="si">{</span><span class="n">ll</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
        <span class="n">mof_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;mof_file&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">mi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">]</span>
        <span class="n">sampled_list</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">mof_list</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">MofCollection</span><span class="p">(</span><span class="n">sampled_list</span><span class="p">,</span> <span class="n">analysis_folder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_folder</span><span class="p">)</span></div>


<div class="viewcode-block" id="MofCollection.filter_collection">
<a class="viewcode-back" href="../../../CoREMOF.calculation.html#CoREMOF.calculation.mof_collection.MofCollection.filter_collection">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">filter_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">using_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">new_collection_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">new_analysis_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter a collection given a number of filters. Calling this method of a MofCollection applies the filter and creates a new collection for the MOFs that match the filter. The cif files that match the filter are  copied to the new_collection_folder. The filters can be one or more of the following: &#39;density&#39;: [min, max] (range of values), &#39;oms_density&#39;: [min, max] (range of values), &#39;uc_volume&#39;:  [min, max] (range of values), &#39;metal_species&#39;: [&quot;Cu&quot;, &quot;Zn&quot;, ...] (list of metal species), &#39;non_metal_species&#39;: [&quot;C&quot;, &quot;N&quot;, ...] (list of non metal species), &#39;cif_okay&#39;: True (boolean value), &#39;has_oms&#39;: True (boolean value), &#39;mof_name&#39;:  [mof_name1, mof_name2] (string values)</span>

<span class="sd">        Args:</span>
<span class="sd">            using_filter: Filter used to identify MOFs with certain characteristics. Has to be a python dictionary.</span>
<span class="sd">            new_collection_folder: Path to the folder where the CIF files of the filtered collection will be stored. If set to None the CIF files will not be copied.</span>
<span class="sd">            new_analysis_folder: Path to the folder where the OMS result files of the filtered collection will be stored. If set to None the result files will not be copied.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A MofCollection with only the filtered MOFs. If new_collection_folder or new_analysis_folder is not set then the collection will point to the original location of these files.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_functions</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">using_filter</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unknown filter. Try again using one of the following &#39;</span>
                  <span class="s1">&#39;filters:</span><span class="se">\n\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_functions</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">validation_level</span><span class="p">,</span> <span class="n">cf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_properties</span><span class="p">(</span><span class="n">using_filter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validation_level</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cf</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Properties from CIF files could not be validated.&#39;</span>
                  <span class="s1">&#39;Check that all CIF files can be read&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">validation_level</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cf</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Requested a filter that needs OMS information but the &#39;</span>
                  <span class="s1">&#39;OMS analysis does not appear to be complete.</span><span class="se">\n</span><span class="s1">&#39;</span>
                  <span class="s1">&#39;Run it first and try again.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Filtering collection.&#39;</span><span class="p">)</span>
        <span class="n">filtered_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">):</span>
            <span class="n">mp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;checksum&#39;</span><span class="p">]]</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_filter</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">fun</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">mp</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">using_filter</span><span class="p">[</span><span class="n">f</span><span class="p">])</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">using_filter</span><span class="p">]):</span>
                <span class="n">filtered_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;mof_file&#39;</span><span class="p">])</span>

        <span class="n">found_s</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;No&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_list</span><span class="p">)}[</span><span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_list</span><span class="p">))]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="s1"> MOFs were matched using the provided&#39;</span>
              <span class="s1">&#39; filter.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">found_s</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No collection returned.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Returning a new collection using the matched MOFs.&#39;</span><span class="p">)</span>
        <span class="n">sub_collection</span> <span class="o">=</span> <span class="n">MofCollection</span><span class="p">(</span><span class="n">filtered_list</span><span class="p">,</span>
                                       <span class="n">analysis_folder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_folder</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span>

        <span class="n">sub_collection</span><span class="o">.</span><span class="n">copy_cifs</span><span class="p">(</span><span class="n">new_collection_folder</span><span class="p">)</span>
        <span class="n">sub_collection</span><span class="o">.</span><span class="n">copy_results</span><span class="p">(</span><span class="n">new_analysis_folder</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sub_collection</span></div>


<div class="viewcode-block" id="MofCollection.read_cif_files">
<a class="viewcode-back" href="../../../CoREMOF.calculation.html#CoREMOF.calculation.mof_collection.MofCollection.read_cif_files">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_cif_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over all MOF files in the collection, load each CIF and store MOF properties such as density, unit cell volume etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading CIF files and updating properties...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loop_over_collection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_property_from_cif_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_properties</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span></div>


<div class="viewcode-block" id="MofCollection.read_oms_results">
<a class="viewcode-back" href="../../../CoREMOF.calculation.html#CoREMOF.calculation.mof_collection.MofCollection.read_oms_results">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_oms_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over all MOF files in the collection, load each OMS result file and store OMS information to the MOF properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding results to properties.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loop_over_collection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_property_from_oms_result</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_properties</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span></div>


<div class="viewcode-block" id="MofCollection.copy_cifs">
<a class="viewcode-back" href="../../../CoREMOF.calculation.html#CoREMOF.calculation.mof_collection.MofCollection.copy_cifs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy_cifs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_folder</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy cif files from their existing location to the specified target_folder.</span>

<span class="sd">        Args:</span>
<span class="sd">            target_folder: Path of folder to copy collection CIF files to.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">target_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">tf_abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">target_folder</span><span class="p">)</span>
        <span class="n">Helper</span><span class="o">.</span><span class="n">make_folder</span><span class="p">(</span><span class="n">tf_abspath</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The cif files for this collection will be copied to&#39;</span>
              <span class="s1">&#39; the specified folder:</span><span class="se">\n\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tf_abspath</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The cif paths will be updated.&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">)):</span>
            <span class="n">destination_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.cif&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tf_abspath</span><span class="p">,</span> <span class="n">mi</span><span class="p">[</span><span class="s1">&#39;mof_name&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mof_name&quot;</span><span class="p">:</span> <span class="n">mi</span><span class="p">[</span><span class="s1">&#39;mof_name&#39;</span><span class="p">],</span>
                                <span class="s2">&quot;mof_file&quot;</span><span class="p">:</span> <span class="n">destination_path</span><span class="p">,</span>
                                <span class="s2">&quot;checksum&quot;</span><span class="p">:</span> <span class="n">mi</span><span class="p">[</span><span class="s1">&#39;checksum&#39;</span><span class="p">]}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">destination_path</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;mof_file&#39;</span><span class="p">],</span> <span class="n">destination_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span></div>


<div class="viewcode-block" id="MofCollection.copy_results">
<a class="viewcode-back" href="../../../CoREMOF.calculation.html#CoREMOF.calculation.mof_collection.MofCollection.copy_results">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_folder</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy OMS result files from their existing location to the specified target_folder.</span>

<span class="sd">        Args:</span>
<span class="sd">            target_folder: Path of folder to copy collection OMS result files to.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">target_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span>
        <span class="n">tf_abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">target_folder</span><span class="p">)</span>
        <span class="n">destination_path</span> <span class="o">=</span> <span class="n">tf_abspath</span> <span class="o">+</span> <span class="s1">&#39;/oms_results&#39;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The result files for this collection will be copied to the &#39;</span>
              <span class="s1">&#39;specified folder:</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s1">The analysis folder will be updated.&#39;</span>
              <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tf_abspath</span><span class="p">))</span>

        <span class="n">Helper</span><span class="o">.</span><span class="n">make_folder</span><span class="p">(</span><span class="n">tf_abspath</span><span class="p">)</span>
        <span class="n">Helper</span><span class="o">.</span><span class="n">make_folder</span><span class="p">(</span><span class="n">destination_path</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">):</span>
            <span class="n">mof_name</span> <span class="o">=</span> <span class="n">mi</span><span class="p">[</span><span class="s1">&#39;mof_name&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_if_results_exist</span><span class="p">(</span><span class="n">mof_name</span><span class="p">):</span>
                <span class="n">source_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oms_results_folder</span><span class="p">,</span> <span class="n">mof_name</span><span class="p">)</span>
                <span class="n">Helper</span><span class="o">.</span><span class="n">copy_folder</span><span class="p">(</span><span class="n">destination_path</span><span class="p">,</span> <span class="n">source_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_folder</span> <span class="o">=</span> <span class="n">tf_abspath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_properties</span><span class="p">([</span><span class="s1">&#39;has_oms&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span></div>


<div class="viewcode-block" id="MofCollection.summarize_results">
<a class="viewcode-back" href="../../../CoREMOF.calculation.html#CoREMOF.calculation.mof_collection.MofCollection.summarize_results">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">summarize_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_atomic_number</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a summary table for the OMS results of the collection, group results by metal type.</span>

<span class="sd">        Args:</span>
<span class="sd">            max_atomic_number: Maximum atomic number to be included in summary table. If not defined all metal atoms will be considered.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_site_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">site_df_u</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;unique&#39;</span><span class="p">]]</span>
        <span class="n">site_df_o</span> <span class="o">=</span> <span class="n">site_df_u</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">site_df_u</span><span class="p">[</span><span class="s1">&#39;is_open&#39;</span><span class="p">]]</span>

        <span class="n">all_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_and_summarize</span><span class="p">(</span><span class="n">site_df_u</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;MOFs&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;Metal Sites&#39;</span><span class="p">])</span>
        <span class="n">open_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_and_summarize</span><span class="p">(</span><span class="n">site_df_o</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;MOFs_with_OMS&#39;</span><span class="p">,</span>
                                                           <span class="s1">&#39;OMS&#39;</span><span class="p">])</span>

        <span class="n">s_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">all_sites</span><span class="p">,</span> <span class="n">open_sites</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">s_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">s_df</span> <span class="o">=</span> <span class="n">s_df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">s_df</span><span class="p">[</span><span class="s1">&#39;MOFs_with_OMS(%)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">s_df</span><span class="p">[</span><span class="s1">&#39;MOFs_with_OMS&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">s_df</span><span class="p">[</span><span class="s1">&#39;MOFs&#39;</span><span class="p">]</span>
        <span class="n">s_df</span><span class="p">[</span><span class="s1">&#39;OMS (%)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">s_df</span><span class="p">[</span><span class="s1">&#39;OMS&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">s_df</span><span class="p">[</span><span class="s1">&#39;Metal Sites&#39;</span><span class="p">]</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MOFs&#39;</span><span class="p">,</span> <span class="s1">&#39;MOFs_with_OMS&#39;</span><span class="p">,</span> <span class="s1">&#39;Metal Sites&#39;</span><span class="p">,</span> <span class="s1">&#39;OMS&#39;</span><span class="p">,</span>
                <span class="s1">&#39;MOFs_with_OMS(%)&#39;</span><span class="p">,</span> <span class="s1">&#39;OMS (%)&#39;</span><span class="p">]</span>
        <span class="n">s_df</span> <span class="o">=</span> <span class="n">s_df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>

        <span class="n">s_df</span><span class="p">[</span><span class="s1">&#39;MOFs_with_OMS(%)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_df</span><span class="p">[</span><span class="s1">&#39;MOFs_with_OMS(%)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1"> %&#39;</span>
                                                                  <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
        <span class="n">s_df</span><span class="p">[</span><span class="s1">&#39;OMS (%)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_df</span><span class="p">[</span><span class="s1">&#39;OMS (%)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1"> %&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
        <span class="n">s_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;MOFs&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">num_mofs</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mof_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
        <span class="n">num_oms_mofs</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_open&#39;</span><span class="p">]][</span><span class="s1">&#39;mof_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
        <span class="n">num_sites</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">site_df_u</span><span class="p">)</span>
        <span class="n">num_oms_sites</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">site_df_u</span><span class="p">[</span><span class="n">site_df_u</span><span class="p">[</span><span class="s1">&#39;is_open&#39;</span><span class="p">]])</span>

        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of total MOFs: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_mofs</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of total MOFs with open metal sites: </span><span class="si">{}</span><span class="s1">&#39;</span>
              <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_oms_mofs</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of total unique sites: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_sites</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of total unique open metal sites: </span><span class="si">{}</span><span class="s1">&#39;</span>
              <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_oms_sites</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Summary Table</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/stats.out&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary_folder</span><span class="p">,</span> <span class="n">max_atomic_number</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_atomic_number</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">s_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Atom</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">&lt;=</span> <span class="n">max_atomic_number</span><span class="p">)</span>
            <span class="n">s_df</span> <span class="o">=</span> <span class="n">s_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">subset</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/stats_less_</span><span class="si">{1}</span><span class="s2">.out&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary_folder</span><span class="p">,</span>
                                                    <span class="n">max_atomic_number</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Summary Table for metal atoms with atomic number smaller &quot;</span> \
                  <span class="s2">&quot;than </span><span class="si">{}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_atomic_number</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">s_df</span><span class="p">)</span>
        <span class="n">s_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MofCollection.summarize_tfactors">
<a class="viewcode-back" href="../../../CoREMOF.calculation.html#CoREMOF.calculation.mof_collection.MofCollection.summarize_tfactors">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">summarize_tfactors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Summarize the t-factor information and make histograms for all the MOFs in the collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tfac_analysis_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_folder</span> <span class="o">+</span> <span class="s1">&#39;/tfac_analysis&#39;</span>
        <span class="n">Helper</span><span class="o">.</span><span class="n">make_folder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary_folder</span><span class="p">)</span>
        <span class="n">Helper</span><span class="o">.</span><span class="n">make_folder</span><span class="p">(</span><span class="n">tfac_analysis_folder</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metal_site_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">sites_u</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;unique&#39;</span><span class="p">]]</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_t_factors</span><span class="p">(</span><span class="n">sites_u</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">tfac_analysis_folder</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_load_mofs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add MOfs to collection, use CIF file checksum as an identifier.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading CIF files...&#39;</span><span class="p">)</span>
        <span class="n">li</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_list</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">lm</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_list</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mof_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">li</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:4.1f}</span><span class="s2"> %&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">lm</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">checksum</span> <span class="o">=</span> <span class="n">Helper</span><span class="o">.</span><span class="n">get_checksum</span><span class="p">(</span><span class="n">mof_file</span><span class="p">)</span>
            <span class="n">mof_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mof_file</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mof_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mof_name&quot;</span><span class="p">:</span> <span class="n">mof_name</span><span class="p">,</span>
                        <span class="s2">&quot;mof_file&quot;</span><span class="p">:</span> <span class="n">mof_file</span><span class="p">,</span>
                        <span class="s2">&quot;checksum&quot;</span><span class="p">:</span> <span class="n">checksum</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mof_info</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">checksum</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">checksum</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mof_name&quot;</span><span class="p">:</span> <span class="n">mof_name</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">checksum</span><span class="p">][</span><span class="s2">&quot;mof_name&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">mof_name</span><span class="p">:</span>
                    <span class="n">exit</span><span class="p">(</span><span class="s2">&quot;MOF name and CIF checksum mismatch for </span><span class="si">{}</span><span class="s2">.cif &quot;</span>
                         <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.cif. Either the CIF files has already been &quot;</span>
                         <span class="s2">&quot;processed with a different name, or the CIF file &quot;</span>
                         <span class="s2">&quot;has changed since it was processed.&quot;</span>
                         <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mof_name</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">checksum</span><span class="p">][</span><span class="s1">&#39;mof_name&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_if_results_exist</span><span class="p">(</span><span class="n">mof_name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compare_checksums</span><span class="p">(</span><span class="n">mof_file</span><span class="p">,</span> <span class="n">mof_name</span><span class="p">,</span> <span class="n">checksum</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">All Done.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_properties</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compare_checksums</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mof_file</span><span class="p">,</span> <span class="n">mof_name</span><span class="p">,</span> <span class="n">checksum</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If OMS results exist for one of the CIF names in the collection then ensure that the CIF checksum matches the one in the result file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mof_folder</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oms_results_folder</span><span class="p">,</span>
                                       <span class="n">mof_name</span><span class="p">)</span>
        <span class="n">results_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mof_folder</span><span class="p">,</span> <span class="n">mof_name</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">results_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">results_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;checksum&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">checksum</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Results for a MOF named </span><span class="si">{0}</span><span class="s2"> appear to already exist&quot;</span>
                  <span class="s2">&quot; in the analysis folder </span><span class="se">\n\&quot;</span><span class="si">{1}</span><span class="se">\&quot;</span><span class="s2">.</span><span class="se">\n</span><span class="s2">However the &quot;</span>
                  <span class="s2">&quot;file checksum in the result file does not match the &quot;</span>
                  <span class="s2">&quot;checksum of </span><span class="se">\n\&quot;</span><span class="si">{2}</span><span class="se">\&quot;</span><span class="s2">.</span><span class="se">\n\n</span><span class="s2">Have the CIF files in the &quot;</span>
                  <span class="s2">&quot;collection changed since the results were computed?&quot;</span>
                  <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Clear results and try again.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mof_name</span><span class="p">,</span>
                                                          <span class="n">mof_folder</span><span class="p">,</span>
                                                          <span class="n">mof_file</span><span class="p">))</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run OMS analysis for each of the batches.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
            <span class="n">status</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_analyse</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span>
        <span class="n">status</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_analyse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mi</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For a given CIF file, create MofStructure object and run OMS analysis. If overwrite is false check if results already exist first.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mof_folder</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oms_results_folder</span><span class="p">,</span> <span class="n">mi</span><span class="p">[</span><span class="s1">&#39;mof_name&#39;</span><span class="p">])</span>
        <span class="n">results_exist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_if_results_exist</span><span class="p">(</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;mof_name&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">results_exist</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping </span><span class="si">{}</span><span class="s2">. Results already exist and overwrite is set &quot;</span>
                  <span class="s2">&quot;to False.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;mof_name&#39;</span><span class="p">]))</span>
            <span class="k">return</span>
        <span class="n">mof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_mof_from_cif_file</span><span class="p">(</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;mof_file&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">mof</span><span class="o">.</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;cif_okay&#39;</span><span class="p">]:</span>
            <span class="n">mof</span><span class="o">.</span><span class="n">analyze_metals</span><span class="p">(</span><span class="n">output_folder</span><span class="o">=</span><span class="n">mof_folder</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_batches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Split collection into number of batches</span>

<span class="sd">        Args:</span>
<span class="sd">            num_batches: Number of batches (default: 1)</span>
<span class="sd">            overwrite: Controls if the results will be overwritten or not (default: False)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cpu_count</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">num_batches</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;You requested </span><span class="si">{}</span><span class="s1"> batches but there are only </span><span class="si">{}</span><span class="s1">&#39;</span>
                          <span class="s1">&#39; CPUs available.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_batches</span><span class="p">,</span> <span class="n">cpu_count</span><span class="p">()))</span>
        <span class="n">b_s</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;batches&#39;</span><span class="p">}[</span><span class="nb">min</span><span class="p">(</span><span class="n">num_batches</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> requested. &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_batches</span><span class="p">,</span> <span class="n">b_s</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Overwrite is set to </span><span class="si">{}</span><span class="s1">. &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">overwrite</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Storing results in </span><span class="si">{}</span><span class="s1">. &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oms_results_folder</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_properties</span><span class="p">([</span><span class="s1">&#39;load_balancing_index&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span>
        <span class="n">lbi</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">mi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">:</span>
            <span class="n">mp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;checksum&#39;</span><span class="p">]]</span>
            <span class="n">lbi</span><span class="p">[</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;mof_name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s1">&#39;load_balancing_index&#39;</span><span class="p">]</span>
        <span class="c1"># Remove any structures not in load balancing index.</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="n">mc</span> <span class="k">for</span> <span class="n">mc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span> <span class="k">if</span> <span class="n">mc</span><span class="p">[</span><span class="s1">&#39;mof_name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">lbi</span><span class="p">]</span>

        <span class="c1"># If there is no balancing info for a MOF at this point it means</span>
        <span class="c1"># that it could not be read.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Skipping </span><span class="si">{}</span><span class="s1"> structures that could not be read.&#39;</span>
                  <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)))</span>

        <span class="c1"># Remove any structures already completed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking if results for any of the MOFs exist...&#39;</span><span class="p">)</span>
            <span class="n">all_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="n">mc</span> <span class="k">for</span> <span class="n">mc</span> <span class="ow">in</span> <span class="n">subset</span> <span class="k">if</span> <span class="ow">not</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">_check_if_results_exist</span><span class="p">(</span><span class="n">mc</span><span class="p">[</span><span class="s1">&#39;mof_name&#39;</span><span class="p">])]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;Will not skip any MOFs&quot;</span><span class="p">,</span>
                   <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;Skipping </span><span class="si">{}</span><span class="s2"> MOFs because results were found. &quot;</span>
                      <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">all_</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">))}</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">all_</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">))])</span>

        <span class="c1"># Sort mof list using the load balancing index</span>
        <span class="n">subset</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">lbi</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;mof_name&#39;</span><span class="p">]])</span>

        <span class="n">sum_load_balance</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">lbi</span><span class="p">[</span><span class="n">mi</span><span class="p">[</span><span class="s2">&quot;mof_name&quot;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">mi</span> <span class="ow">in</span> <span class="n">subset</span><span class="p">)</span>
        <span class="n">lb_per_batch</span> <span class="o">=</span> <span class="n">sum_load_balance</span> <span class="o">/</span> <span class="n">num_batches</span>

        <span class="c1"># Select only up to analysis_limit to work with</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_limit</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_limit</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_limit</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">batches</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_batches</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subset</span><span class="p">):</span>
            <span class="n">sum_lb</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">lbi</span><span class="p">[</span><span class="n">mi</span><span class="p">[</span><span class="s2">&quot;mof_name&quot;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">mi</span> <span class="ow">in</span> <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]])</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sum_lb</span> <span class="o">/</span> <span class="n">lb_per_batch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">[</span><span class="n">batch</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Batch </span><span class="si">{0}</span><span class="s2"> has </span><span class="si">{1}</span><span class="s2"> MOFs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_if_results_exist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mof_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if OMS results already exist for a MOF&quot;&quot;&quot;</span>
        <span class="n">mof_folder</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oms_results_folder</span><span class="p">,</span> <span class="n">mof_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">mof_folder</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">mof_name</span><span class="o">+</span><span class="s1">&#39;.json&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">mof_folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;analysis_running&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_loop_over_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over all the MOFs in the collection and run the specified function.</span>
<span class="sd">        Args:</span>
<span class="sd">            func: Function to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">li</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">lm</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">li</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:4.1f}</span><span class="s2"> % </span><span class="si">{}</span><span class="s2"> </span><span class="si">{:100}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">lm</span><span class="p">,</span> <span class="n">mi</span><span class="p">[</span><span class="s1">&#39;mof_name&#39;</span><span class="p">],</span>
                                                   <span class="s2">&quot; &quot;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">func</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply the proper filter_function for the given filter&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_functions</span><span class="p">[</span><span class="n">filter_</span><span class="p">](</span><span class="n">v</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_filter_value</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter function to match a value. Returns false if values is None&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">v</span> <span class="o">==</span> <span class="n">f</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_filter_in_value</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter function to match all values of a list&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">([</span><span class="n">f_</span> <span class="ow">in</span> <span class="n">v</span> <span class="k">for</span> <span class="n">f_</span> <span class="ow">in</span> <span class="n">f</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_value_in_filter</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter function to match any of the values of a list&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">f</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_filter_range</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter function to match a range of values&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="nb">max</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a given property can be found in the properties dictionary. If not try to read the CIF file and check again. If the check fails again try to read the OMS results and check again. If the check fails a third time return False, the property cannot be validated.&quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;Validating property&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;Validating properties&quot;</span><span class="p">}</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="s1"> : &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">))]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">])))</span>
        <span class="n">validation_level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">li</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">lm</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mof_coll</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">li</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:4.1f}</span><span class="s2"> % </span><span class="si">{}</span><span class="s2"> </span><span class="si">{:100}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">lm</span><span class="p">,</span> <span class="n">mi</span><span class="p">[</span><span class="s1">&#39;mof_name&#39;</span><span class="p">],</span>
                                                   <span class="s2">&quot; &quot;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">mp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;checksum&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_property</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_property_from_cif_file</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
                <span class="n">validation_level</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_property</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_property_from_oms_result</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
                <span class="n">validation_level</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_property</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_store_properties</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Property Missing</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">validation_level</span><span class="p">,</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_properties</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Validated 100 % &quot;</span><span class="o">+</span><span class="mi">100</span><span class="o">*</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">validation_level</span><span class="p">,</span> <span class="kc">True</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_property</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if property exists.&quot;&quot;&quot;</span>
        <span class="n">test1</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">f</span> <span class="ow">in</span> <span class="n">mp</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">test1</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">mp</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;N/A&#39;</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">test1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mp</span><span class="p">[</span><span class="s1">&#39;cif_okay&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_property_from_cif_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mi</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update properties dictionary from a CIF file.&quot;&quot;&quot;</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;checksum&#39;</span><span class="p">]]</span>
        <span class="n">mof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_mof_from_cif_file</span><span class="p">(</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;mof_file&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">mof</span><span class="p">:</span>
            <span class="n">mp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mof</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_balance_index</span><span class="p">[</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;mof_name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mof</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">mof</span><span class="p">)</span>
            <span class="n">mp</span><span class="p">[</span><span class="s1">&#39;load_balancing_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_balance_index</span><span class="p">[</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;mof_name&#39;</span><span class="p">]]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_property_from_oms_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mi</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update properties dictionary from an OMS result file.&quot;&quot;&quot;</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">mi</span><span class="p">[</span><span class="s1">&#39;checksum&#39;</span><span class="p">]]</span>
        <span class="n">mof_name</span> <span class="o">=</span> <span class="n">mp</span><span class="p">[</span><span class="s2">&quot;mof_name&quot;</span><span class="p">]</span>
        <span class="n">mof_folder</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oms_results_folder</span><span class="p">,</span> <span class="n">mof_name</span><span class="p">)</span>
        <span class="n">results_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mof_folder</span><span class="p">,</span> <span class="n">mof_name</span><span class="p">)</span>
        <span class="n">results_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">results_file</span><span class="p">):</span>
            <span class="n">results_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">results_file</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;source_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mof_folder</span>
            <span class="n">mp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">results_dict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_store_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Store properties dictionary as a python pickle file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_properties_filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">properties_file</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">,</span> <span class="n">properties_file</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_mof_from_cif_file</span><span class="p">(</span><span class="n">path_to_mof</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create and return a MofStructure object from a path to a CIF file.&quot;&quot;&quot;</span>
        <span class="n">mof</span> <span class="o">=</span> <span class="n">MofStructure</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">path_to_mof</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mof</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_write_t_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Summarize the findings in table form and histograms for a give t-factor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s_n</span> <span class="o">=</span> <span class="n">sites</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sites</span><span class="p">[</span><span class="s1">&#39;number_of_linkers&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">s_n</span><span class="p">[</span><span class="s1">&#39;is_open_yn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">s_n</span><span class="p">[</span><span class="s1">&#39;is_open&#39;</span><span class="p">],</span> <span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">)</span>
        <span class="n">s_n</span> <span class="o">=</span> <span class="n">s_n</span><span class="p">[[</span><span class="s1">&#39;mof_name&#39;</span><span class="p">,</span> <span class="s1">&#39;is_open_yn&#39;</span><span class="p">,</span> <span class="s1">&#39;t_factor&#39;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">]:</span>
            <span class="n">outpath</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.out&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s_n</span><span class="p">[</span><span class="n">s_n</span><span class="p">[</span><span class="s1">&#39;is_open_yn&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">flag</span><span class="p">]</span>
            <span class="n">s</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">fout</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_hist.out&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_histogram</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;t_factor&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">,</span> <span class="n">fout</span><span class="p">)</span>
            <span class="n">fout</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_hist_abs.out&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_histogram</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;t_factor&#39;</span><span class="p">],</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fout</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;t-</span><span class="si">{}</span><span class="s1"> factor&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
        <span class="n">s_yes</span> <span class="o">=</span> <span class="n">s_n</span><span class="p">[</span><span class="n">s_n</span><span class="p">[</span><span class="s1">&#39;is_open_yn&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">]</span>
        <span class="n">s_yes</span><span class="p">[</span><span class="s1">&#39;t_factor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">normed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">s_no</span> <span class="o">=</span> <span class="n">s_n</span><span class="p">[</span><span class="n">s_n</span><span class="p">[</span><span class="s1">&#39;is_open_yn&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;no&#39;</span><span class="p">]</span>
        <span class="n">s_no</span><span class="p">[</span><span class="s1">&#39;t_factor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">normed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_write_histogram</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">dens</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate histograms to be used for summarizing the t-factor results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hist</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">density</span><span class="o">=</span><span class="n">dens</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hist_file</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">hist</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">hist_file</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_group_and_summarize</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Group the DataFrame holding the OMS results by metal type and rename its columns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rename</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mof_name&quot;</span><span class="p">:</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;is_open&quot;</span><span class="p">:</span> <span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
        <span class="n">agg_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mof_name&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">nunique</span><span class="p">,</span> <span class="s2">&quot;is_open&quot;</span><span class="p">:</span> <span class="s2">&quot;count&quot;</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;metal&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg_dict</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">rename</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, MTAP @ Pusan National University.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>